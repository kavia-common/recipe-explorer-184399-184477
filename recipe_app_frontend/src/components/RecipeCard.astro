---
import type { Recipe } from "../lib/api";

export interface Props {
  recipe: Recipe;
  isFav?: boolean;
}
const { recipe, isFav = false } = Astro.props as Props;
const detailUrl = `/recipes/${encodeURIComponent(recipe.id)}`;
---
<article class="card recipe" aria-label={`Recipe ${recipe.title}`}>
  <a class="thumb" href={detailUrl} aria-label={`Open ${recipe.title}`}>
    <img src={recipe.image} alt={recipe.title} loading="lazy" />
    {recipe.popular && <span class="badge pop">Popular</span>}
  </a>
  <div class="content">
    <div class="row1">
      <a class="title" href={detailUrl}>{recipe.title}</a>
      <button class="fav-btn" data-id={recipe.id} aria-pressed={isFav ? "true" : "false"} aria-label="Toggle favorite">
        {isFav ? "‚òÖ" : "‚òÜ"}
      </button>
    </div>
    <div class="meta">
      <span class="pill">{recipe.category}</span>
      <span class="badge" title="Time">‚è± {recipe.time}m</span>
      <span class="badge" title="Servings">üçΩ {recipe.servings}</span>
    </div>
    <div class="ings" title={recipe.ingredients.join(', ')}>
      {recipe.ingredients.slice(0,3).join(' ‚Ä¢ ')}{recipe.ingredients.length>3 ? '‚Ä¶' : ''}
    </div>
  </div>
</article>

<style>
  .recipe { overflow: hidden; }
  .thumb { display: block; position: relative; }
  .thumb img { width: 100%; height: 160px; object-fit: cover; display: block; }
  .pop { position: absolute; top: 10px; left: 10px; }
  .content { padding: 12px; display: flex; flex-direction: column; gap: 8px; }
  .row1 { display: flex; justify-content: space-between; gap: 12px; align-items: start; }
  .title { color: var(--text); text-decoration: none; font-weight: 700; line-height: 1.2; }
  .title:hover { text-decoration: underline; }
  .fav-btn {
    background: white; color: #f59e0b; border: 1px solid var(--border);
    border-radius: 10px; padding: 6px 10px; min-width: 40px;
  }
  .meta { display: flex; flex-wrap: wrap; gap: 6px; }
  .ings { color: var(--muted); font-size: .9rem; }
</style>

<script>
  import { toggleFavorite } from "../lib/favorites";

  function attach(btn: HTMLButtonElement) {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = btn.getAttribute('data-id');
      if (!id) return;
      const on = toggleFavorite(id);
      btn.textContent = on ? "‚òÖ" : "‚òÜ";
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      document.dispatchEvent(new CustomEvent('favorites:changed'));
    });
  }

  document.querySelectorAll('.fav-btn').forEach((el) => attach(el as HTMLButtonElement));

  document.addEventListener('astro:after-swap', () => {
    document.querySelectorAll('.fav-btn').forEach((el) => attach(el as HTMLButtonElement));
  });
</script>
